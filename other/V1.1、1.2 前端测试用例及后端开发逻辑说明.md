
对比 V1.0，V1.1 最主要的变化是添加了“场景-主题”层级。

所有的配置表大致可以分为两类，一种是主题无关的，即同一个场景下，所有主题使用的都是同一份数据，如意图识别表、标签规则表；另一种是主题相关的，即不同主题下它们的内容可能是不同的，如 open/reopen 下的具体一级标签表或流程表等。

因此作为接口，几乎所有的接口均需要提供一级场景信息、二级场景信息，与主题相关的接口需要提供主题信息参数。

## 一、前端接口用例及说明

### 1.2 场景级资源管理接口

场景级资源是指，不与具体主题绑定的配置表，即同一场景下，所有主题使用同一个配置表，这类资源配置表目前有：意图配置（intent）和标签规则（label_rule）

此类资源的表头相对固定，前端可固定展示

因此，此类接口通常有三个固定参数：一级场景、二级场景、资源类型（intent or label_rule）

#### 1.2.1 遍历资源列表（遍历）

接口：（get）/api/scene-resource/

支持分页查询，关键字查询以及支持对已删除资源的查询等

#### 1.2.2 新增资源（增）

接口：（post）/api/scene-resource/

首先指明资源类型

对于意图：
```json
{
  "first_scene": "string",
  "second_scene": "string",
  "intent_name": "string",
  "intent_description": "string",
  "example_1": "string",
  "example_2": "string",
  "example_3": "string"
}
```

对于标签规则：
```json
{
  "first_scene": "string",
  "second_scene": "string",
  "first_label_id": "string",
  "first_label_name": "string",
  "tf_second_label_id": "string",
  "ai_second_label_id": "string",
  "second_label_name": "string",
  "rule": "string",
  "remark": "string"
}
```

#### 1.2.3 查询资源（查）

接口：（post）/api/scene-resource/{item_id}

通过指定 item_id 一级资源类型获取单个资源的详细数据

#### 1.2.4 更新资源（改）

接口：（put）/api/scene-resource/{item_id}

注：此处的”改“，仅指修改资源数据项本身，不能通过该接口修改资源状态

参数与新增资源一致，如果资源目前被使用中，禁止修改

## 二、后端开发逻辑说明

### 1.2 场景级资源管理接口

#### 2.2.1 遍历资源列表

后端在存储数据上使用了三级配置：

* 元数据表（metadata）：主要存储表头，当前版本信息等元数据
* 数据表（intent/label_rules）：存储当前最新版本的具体数据
* 历史表（history）：存储历史版本数据（版本是以整个配置表为单位）

其中数据表下 intent 和 label_rules 是分开存储，而元数据表和历史表则放在一起

遍历的开发逻辑相对简单，仅需要根据资源类型到指定的数据表

中查询即可，并记录总条数。


#### 2.2.2 新增资源

需要区分资源类型：意图 或 标签规则

1. 将当前数据保存到历史表中
2. 创建新资源
3. 添加新资源
4. 更新元数据表中关于该资源的版本信息
5. 如果是新增意图，发送相应提示到微信群
6. 返回资源 id，字段统一为 item_id

#### 2.2.3 查询资源

逻辑简单，仅需从指定的资源数据表中查询并返回结果即可

#### 2.2.4 更新资源

目前的开发逻辑：

1. 找到指定的资源项
2. 将现有数据保存到历史表中
3. 更新资源数据
4. 更新元数据表中的版本信息
5. 返回规则 id

更新后的开发逻辑：

1. 找到指定的资源项
2. 遍历当前场景下，已处于开启状态的主题下，是否存在状态为”已发布“的规则或流程中涉及到该资源项（类似智能联动检测）
3. 如果存在，则不允许修改，即如果某个上层资源项被处于已发布的具体规则或流程所引用的情况下，都不允许对数据源进行修改，也禁止此类行为下的数据联动，确保已发布状态的规则或流程不被破坏。
4. 如果不存在被引用，则允许修改




## 2、标签规则管理

### 2.1 标签规则列表：list

接口：/label-rules/list

参数说明：需要指定一、二级场景信息，无需主题信息，同一个场景下的主题共享一套标签规则

```python
first_scene: LITB/MINI/OUKU
second_scene: Ticket
```

结果展示：

```json
{
  "code": 200,
  "message": "获取成功",
  "datas": {
    "rules": [
      {
        "rule_id": "af2b09d6-e0d5-4f15-afb9-40ef3134f23a",
        "first_scene": "LITB/MINI/OUKU",
        "second_scene": "Ticket",
        "first_label_id": "Return Or Exchange",
        "first_label_name": "退货或换货",
        "tf_second_label_id": "Product with quality issue",
        "ai_second_label_id": "Product with quality issue",
        "second_label_name": "产品有质量问题",
        "rule": "质量差等。例如衣服鞋包类产品问题包括：面料瑕疵(如破损、抽丝、起球等），材料或衣物透明、透光，能够看到背后的物体或皮肤，缝制不良（线迹不整齐、跳线、断线、开线等），污渍类（斑点、记号笔印记等），掉色染色，配件问题（如拉链损坏、纽扣不牢固等），变形走样，异味残留（可能有刺鼻的化学气味或其他难闻味道），毛边未处理（边缘裁剪不整齐，有多余毛边），图案印制问题：图案模糊、残缺、易脱落等问题。再如：电子产品存在屏幕显示异常、电池续航差、频繁死机、信号接收不良、按键失灵、无法开关机、漏电、散热不良等问题。其他类型产品的其他质量问题等",
        "remark": "系统初始录入",
		"open_status": "close",
        "status": "待发布",
        "created_by": "system",
        "updated_by": "system",
        "created_at": "2025-07-08T15:57:47.594000",
        "updated_at": "2025-07-08T15:57:47.594000"
      },
      {
			...
      }
    ],
    "total": 416,
    "page": 1,
    "page_size": 2
  }
}
```

### 2.2 新增规则：create

接口：（post）/label-rules/

参数说明：

```json
{
  "first_scene": "LITB/MINI/OUKU",
  "second_scene": "Ticket",
  "first_label_id": "bagagaa",
  "first_label_name": "八嘎",
  "tf_second_label_id": "gaba",
  "ai_second_label_id": "gabab",
  "second_label_name": "嘎巴",
  "rule": "test",
  "remark": "test"
}
```

注：标签规则设置的唯一条件是：场景+一级标签+TF二级标签+AI二级标签，即这个组合值要求唯一，否则无法新增规则

失败结果展示：

```json
{
  "code": 700,
  "message": "保存规则失败: 已存在同名的一二级场景 + 一级标签 + TF二级标签 + AI二级标签组合",
  "datas": null
}
```

成功结果展示，将新增规则的 rule_id 返回：

```json
{
  "code": 200,
  "message": "标签规则创建成功",
  "datas": {
    "rule_id": "a44b1f3c-78e8-4539-84e3-d7f7630d2acf",
    "version": 6,
    "message": "规则添加成功"
  }
}
```

注：默认新增的标签规则的开启状态都是 close，且处于待发布状态

### 2.3 获取标签规则：get

接口：（get）/label-rules/{rule_id}

参数说明：需要提供 rule_id，同时提供一二级场景信息

示例：

rule_id = a44b1f3c-78e8-4539-84e3-d7f7630d2acf；
first_scene = LITB/MINI/OUKU
second_scene = Ticket

结果展示：

```json
{
  "code": 200,
  "message": "获取成功",
  "datas": {
    "rule_id": "a44b1f3c-78e8-4539-84e3-d7f7630d2acf",
    "first_scene": "LITB/MINI/OUKU",
    "second_scene": "Ticket",
    "first_label_id": "bagagaaa",
    "first_label_name": "八嘎",
    "tf_second_label_id": "gaba",
    "ai_second_label_id": "gabab",
    "second_label_name": "嘎巴",
    "rule": "test",
    "remark": "嘎嘎嘎",
    "open_status": "close",
    "status": "待发布",
    "created_by": "姜鹏",
    "updated_by": "姜鹏",
    "created_at": "2025-07-09T09:52:46.533000",
    "updated_at": "2025-07-09T10:17:55.797000"
  }
}
```


### 2.4 更新标签规则：update

接口：（put）/label-rules/{rule_id}

参数说明：需要提供 rule_id，同时提供一二级场景信息

示例：rule_id = a44b1f3c-78e8-4539-84e3-d7f7630d2acf

```json
{
  "first_scene": "LITB/MINI/OUKU",
  "second_scene": "Ticket",
  "remark": "嘎嘎嘎"
}
```

结果展示：

```json
{
  "code": 200,
  "message": "标签规则更新成功",
  "datas": {
    "rule_id": "a44b1f3c-78e8-4539-84e3-d7f7630d2acf",
    "version": 7,
    "message": "标签规则更新成功"
  }
}
```

注：这里的标签规则更新，仅仅指一般性的，如具体的规则或备注等常规信息的更新，不能通过该接口修改规则的状态。

### 2.5 删除标签规则：delete

接口：（delete）/label-rules/{rule_id}

参数说明：需要提供 rule_id，同时提供一二级场景信息，示例参数同上

结果展示：

```json
{
  "code": 200,
  "message": {
    "rule_id": "a44b1f3c-78e8-4539-84e3-d7f7630d2acf",
    "version": 9,
    "message": "规则删除成功"
  },
  "datas": {
    "rule_id": "a44b1f3c-78e8-4539-84e3-d7f7630d2acf"
  }
}
```

### 2.6 标签状态更新

接口：（put）/label-rules/{rule_id}/status

注：标签状态的更新，存在一些转换顺序的问题，以及状态定义，这部分内容带产品进一步确认

开启状态为 close 的情况下，始终禁止任意状态直接向“已发布”状态进行转换
而开始状态的变更，只允许通过主题层面的接口进行变更，禁止基于具体规则表变更开启状态

成功案例：

```json
{
  "code": 200,
  "message": {
    "rule_id": "a44b1f3c-78e8-4539-84e3-d7f7630d2acf",
    "version": 10,
    "message": "标签规则状态更新成功"
  },
  "datas": {
    "config_id": "a44b1f3c-78e8-4539-84e3-d7f7630d2acf"
  }
}
```

失败案例：

```json
{
  "code": 400,
  "message": "无法从 待发布 转换到 已发布",
  "datas": null
}
```


### 2.7 获取当前版本

接口：（get）/label-rules/versions/current

参数：需要提供一二级场景信息

示例：

```json
{
  "code": 200,
  "message": "获取成功",
  "datas": {
    "current_version": 3
  }
}
```

### 2.8 版本历史

接口：（get）/label-rules/versions/history

注：此接口目前仅提供各历史版本的备注信息，不提供各版本之间的差异或各版本的具体数据

### 2.9 版本比较

接口（post）/label-rules/versions/compare

参数：需要提供一二级场景和两个版本信息

注：此接口，只允许同一场景下不同版本见的比较

```json
{
  "code": 200,
  "message": "比较完成",
  "datas": {
    "old_version": 1,
    "new_version": 3,
    "summary": {
      "total_changes": 2,
      "added_count": 2,
      "deleted_count": 0,
      "modified_count": 0
    },
    "differences": [
      {
        "type": "added",
        "item_id": "2737777d-bfa4-432b-8c29-e2713070b224",
        "version": 3,
        "item_data": {
          "rule_id": "2737777d-bfa4-432b-8c29-e2713070b224",
          "first_scene": "LITB/MINI/OUKU",
          "second_scene": "Ticket",
          "first_label_id": "xxx",
          "first_label_name": "x",
          "tf_second_label_id": "xxx",
          "ai_second_label_id": "x",
          "second_label_name": "x",
          "rule": "x",
          "remark": "x",
          "open_status": "close",
          "status": "待发布",
          "created_by": "姜鹏",
          "updated_by": "姜鹏",
          "created_at": "2025-07-09T13:26:37.506000",
          "updated_at": "2025-07-09T13:26:37.506000"
        },
        "preview": {
          "first_label_name": "\"x\"",
          "second_label_name": "\"x\"",
          "rule": "\"x\""
        }
      },
      {
		...
      }
    ]
  }
}
```

### 2.10 版本回退

接口：（post）/label-rules/versions/revert

参数：需要提供一二级场景和目标版本信息

注：回退后，数据的开启情况与具体的状态信息将完全与之前版本存档时的状态一致，

开启状态通常可以直接带入，如果具体状态信息需要重置或者其他选择，后期需确认一下。

### 2.11 具体规则的两版本间比较

接口：（get）/label-rules/rule-compare/{rule_id}

注：这里的比较是非常详细的，基本是复现了 git 中版本比较的功能，可酌情筛选使用

```json
{
  "code": 200,
  "message": "标签规则对比完成",
  "datas": {
    "status": "modified",
    "message": "标签规则在版本 6 到 7 之间发生变化",
    "field_changes": [
      {
        "field": "first_label_name",
        "field_name": "一级标签名称",
        "change_type": "field_modified",
        "old_value": "八嘎",
        "new_value": "八嘎aega",
        "old_display": "\"八嘎\"",
        "new_display": "\"八嘎aega\"",
        "diff_detail": {
          "old_type": "str",
          "new_type": "str",
          "string_diff": [
            "--- old\n",
            "+++ new\n",
            "@@ -1 +1 @@\n",
            "-八嘎",
            "+八嘎aega"
          ],
          "old_length": 2,
          "new_length": 6,
          "similarity": 0.5
        },
        "importance": "high"
      },
      {
        "field": "second_label_name",
        "field_name": "二级标签名称",
        "change_type": "field_modified",
        "old_value": "嘎巴sdfg",
        "new_value": "嘎巴awesdfg",
        "old_display": "\"嘎巴sdfg\"",
        "new_display": "\"嘎巴awesdfg\"",
        "diff_detail": {
          "old_type": "str",
          "new_type": "str",
          "string_diff": [
            "--- old\n",
            "+++ new\n",
            "@@ -1 +1 @@\n",
            "-嘎巴sdfg",
            "+嘎巴awesdfg"
          ],
          "old_length": 6,
          "new_length": 9,
          "similarity": 0.8
        },
        "importance": "high"
      },
      {
        "field": "tf_second_label_id",
        "field_name": "TF二级标签ID",
        "change_type": "field_modified",
        "old_value": "gabaaedoa",
        "new_value": "gadoa",
        "old_display": "\"gabaaedoa\"",
        "new_display": "\"gadoa\"",
        "diff_detail": {
          "old_type": "str",
          "new_type": "str",
          "string_diff": [
            "--- old\n",
            "+++ new\n",
            "@@ -1 +1 @@\n",
            "-gabaaedoa",
            "+gadoa"
          ],
          "old_length": 9,
          "new_length": 5,
          "similarity": 0.7142857142857143
        },
        "importance": "high"
      }
    ],
    "old_item": {
      "rule_id": "80b478ae-3509-4878-9b3f-670a634e3336",
      "first_scene": "LITB/MINI/OUKU",
      "second_scene": "Ticket",
      "first_label_id": "bag",
      "first_label_name": "八嘎",
      "tf_second_label_id": "gabaaedoa",
      "ai_second_label_id": "gabab",
      "second_label_name": "嘎巴sdfg",
      "rule": "test",
      "remark": "test",
      "open_status": "close",
      "status": "待发布",
      "created_by": "姜鹏",
      "updated_by": "姜鹏",
      "created_at": "2025-07-09T15:42:09.880000",
      "updated_at": "2025-07-09T15:42:09.880000"
    },
    "new_item": {
      "rule_id": "80b478ae-3509-4878-9b3f-670a634e3336",
      "first_scene": "LITB/MINI/OUKU",
      "second_scene": "Ticket",
      "first_label_id": "bag",
      "first_label_name": "八嘎aega",
      "tf_second_label_id": "gadoa",
      "ai_second_label_id": "gabab",
      "second_label_name": "嘎巴awesdfg",
      "rule": "test",
      "remark": "test",
      "open_status": "close",
      "status": "待发布",
      "created_by": "姜鹏",
      "updated_by": "姜鹏",
      "created_at": "2025-07-09T15:42:09.880000",
      "updated_at": "2025-07-09T15:42:59.848000"
    },
    "change_summary": {
      "total_fields_changed": 3,
      "changed_fields": [
        "一级标签名称",
        "二级标签名称",
        "TF二级标签ID"
      ],
      "fields_added": 0,
      "fields_removed": 0,
      "fields_modified": 3,
      "high_importance_changes": 3
    }
  }
}
```


### 2.12 具体规则在各历史版本间的比较

接口：（get）/label-rules/rule-history/{rule_id}

注：该接口将返回指定的规则，在所有历史版本中相继两个版本中所做的变化，重点是从何时（哪个版本）开始创建、后续各版本分别做的哪些变化，也是仿 git 做的。


## 3、字段管理

注：在 V1.0 基础上加入一二级场景信息，无需区分主题，只包含基础 CRUD 接口，该部分接口未来引入管理员权限，不对一般用户开放，因此，不做版本管理相关的维护。



---------

TODO list：

1. 主题激活，修改为，只允许处于待发布状态的规则变更为已发布；原来已发布的主题下的状态全部变更为待发布