
æœ¬æ¨¡å—å°†æŒ‡å¯¼ä½ å®ŒæˆæŒ‡ä»¤å¾®è°ƒè¯­è¨€æ¨¡å‹çš„æ“ä½œã€‚æŒ‡ä»¤å¾®è°ƒæ˜¯æŒ‡é€šè¿‡åœ¨ç‰¹å®šä»»åŠ¡çš„ä¸“ç”¨æ•°æ®é›†ä¸Šå¯¹é¢„è®­ç»ƒæ¨¡å‹è¿›è¡Œè¿›ä¸€æ­¥è®­ç»ƒï¼Œä½¿å…¶é€‚åº”ç‰¹å®šä»»åŠ¡çš„è¿‡ç¨‹ã€‚è¿™ä¸€è¿‡ç¨‹æœ‰åŠ©äºæ¨¡å‹æå‡åœ¨ç›®æ ‡ä»»åŠ¡ä¸Šçš„è¡¨ç°ã€‚

åœ¨æœ¬æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ä¸¤ä¸ªä¸»é¢˜ï¼š*1ï¼‰* èŠå¤©æ¨¡æ¿ï¼›*2ï¼‰* æœ‰ç›‘ç£å¾®è°ƒã€‚

* èŠå¤©æ¨¡æ¿ï¼šèŠå¤©æ¨¡æ¿æ„å»ºäº†ç”¨æˆ·ä¸ AI æ¨¡å‹ä¹‹é—´çš„äº¤äº’ç»“æ„ï¼Œç¡®ä¿å“åº”çš„ä¸€è‡´æ€§å’Œä¸Šä¸‹æ–‡ç›¸å…³æ€§ã€‚å®ƒä»¬åŒ…æ‹¬ç³»ç»Ÿæç¤ºå’ŒåŸºäºè§’è‰²çš„æ¶ˆæ¯ç­‰ç»„ä»¶ã€‚
* SFTï¼šç›‘ç£å¾®è°ƒï¼ˆSFTï¼‰æ˜¯å°†é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹é€‚é…åˆ°ç‰¹å®šä»»åŠ¡çš„å…³é”®è¿‡ç¨‹ã€‚å®ƒæ¶‰åŠåœ¨å¸¦æœ‰æ ‡è®°ç¤ºä¾‹çš„ç‰¹å®šä»»åŠ¡æ•°æ®é›†ä¸Šå¯¹æ¨¡å‹è¿›è¡Œè®­ç»ƒã€‚

## ä¸€ã€èŠå¤©æ¨¡æ¿

èŠå¤©æ¨¡æ¿å¯¹äºæ„å»ºè¯­è¨€æ¨¡å‹ä¸ç”¨æˆ·ä¹‹é—´çš„äº¤äº’è‡³å…³é‡è¦ã€‚å®ƒä»¬ä¸ºå¯¹è¯æä¾›äº†ç»Ÿä¸€çš„æ ¼å¼ï¼Œç¡®ä¿æ¨¡å‹ç†è§£æ¯æ¡æ¶ˆæ¯çš„ä¸Šä¸‹æ–‡å’Œè§’è‰²ï¼ŒåŒæ—¶ä¿æŒé€‚å½“çš„å›åº”æ¨¡å¼ã€‚

### 1.1 åŸºç¡€æ¨¡å‹ä¸æŒ‡ä»¤æ¨¡å‹

åŸºç¡€æ¨¡å‹åœ¨åŸå§‹æ–‡æœ¬æ•°æ®ä¸Šè¿›è¡Œè®­ç»ƒä»¥é¢„æµ‹ä¸‹ä¸€ä¸ªæ ‡è®°ï¼Œè€ŒæŒ‡ä»¤æ¨¡å‹åˆ™ç»è¿‡å¾®è°ƒä¸“é—¨ç”¨äºéµå¾ªæŒ‡ä»¤å¹¶è¿›è¡Œå¯¹è¯ã€‚ä¾‹å¦‚ï¼Œ`SmolLM2-135M` æ˜¯ä¸€ä¸ªåŸºç¡€æ¨¡å‹ï¼Œè€Œ `SmolLM2-135M-Instruct` æ˜¯å…¶æŒ‡ä»¤å¾®è°ƒå˜ä½“ã€‚

è¦è®©åŸºç¡€æ¨¡å‹è¡¨ç°å‡ºæŒ‡ä»¤æ¨¡å‹çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ä¸€ç§æ¨¡å‹èƒ½å¤Ÿç†è§£çš„è¿è´¯æ–¹å¼æ¥æ ¼å¼åŒ–æç¤ºè¯ã€‚è¿™æ—¶å°±éœ€è¦ç”¨åˆ°èŠå¤©æ¨¡æ¿ã€‚ChatML å°±æ˜¯è¿™æ ·ä¸€ä¸ªæ¨¡æ¿æ ¼å¼ï¼Œå®ƒé€šè¿‡æ˜ç¡®çš„è§’è‰²æ ‡è¯†ï¼ˆç³»ç»Ÿã€ç”¨æˆ·ã€åŠ©æ‰‹ï¼‰æ¥æ„å»ºå¯¹è¯ç»“æ„ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒåŸºç¡€æ¨¡å‹å¯ä»¥åœ¨ä¸åŒçš„èŠå¤©æ¨¡æ¿ä¸Šè¿›è¡Œå¾®è°ƒï¼Œå› æ­¤å½“æˆ‘ä»¬ä½¿ç”¨æŒ‡ä»¤æ¨¡å‹æ—¶ï¼Œéœ€è¦ç¡®ä¿ä½¿ç”¨äº†æ­£ç¡®çš„èŠå¤©æ¨¡æ¿ã€‚

### 1.2 ç†è§£èŠå¤©æ¨¡æ¿

ä»æ ¹æœ¬ä¸Šè¯´ï¼ŒèŠå¤©æ¨¡æ¿å®šä¹‰äº†ä¸è¯­è¨€æ¨¡å‹äº¤æµæ—¶å¯¹è¯åº”é‡‡ç”¨çš„æ ¼å¼ã€‚å®ƒä»¬ä»¥æ¨¡å‹èƒ½å¤Ÿç†è§£çš„ç»“æ„åŒ–æ ¼å¼ï¼ŒåŒ…å«ç³»ç»Ÿçº§æŒ‡ä»¤ã€ç”¨æˆ·æ¶ˆæ¯å’ŒåŠ©æ‰‹å›å¤ã€‚è¿™ç§ç»“æ„æœ‰åŠ©äºåœ¨ä¸åŒäº¤äº’ä¸­ä¿æŒä¸€è‡´æ€§ï¼Œå¹¶ç¡®ä¿æ¨¡å‹èƒ½å¯¹ä¸åŒç±»å‹çš„è¾“å…¥åšå‡ºæ°å½“å›åº”ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªèŠå¤©æ¨¡æ¿çš„ç¤ºä¾‹ã€‚

```sh
<|im_start|>user
Hi there!<|im_end|>
<|im_start|>assistant
Nice to meet you!<|im_end|>
<|im_start|>user
Can I ask a question?<|im_end|>
<|im_start|>assistant
```

`transformers` åº“å°†æ ¹æ®æ¨¡å‹çš„åˆ†è¯å™¨ä¸ºä½ å¤„ç†èŠå¤©æ¨¡æ¿ã€‚æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯ä»¥æ­£ç¡®çš„æ–¹å¼ç»„ç»‡æˆ‘ä»¬çš„æ¶ˆæ¯ï¼Œå…¶ä½™çš„äº‹æƒ…å°†ç”±åˆ†è¯å™¨æ¥å¤„ç†ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªåŸºæœ¬å¯¹è¯ç¤ºä¾‹ï¼š

```python
messages = [
    {"role": "system", "content": "You are a helpful assistant focused on technical topics."},
    {"role": "user", "content": "Can you explain what a chat template is?"},
    {"role": "assistant", "content": "A chat template structures conversations between users and AI models..."}
]
```

è®©æˆ‘ä»¬åˆ†è§£ä¸Šé¢çš„ä¾‹å­ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•æ˜ å°„åˆ°èŠå¤©æ¨¡æ¿æ ¼å¼çš„ã€‚

### 1.3 ç³»ç»Ÿæ¶ˆæ¯

ç³»ç»Ÿæ¶ˆæ¯ä¸ºæ¨¡å‹çš„è¡Œä¸ºæ–¹å¼å¥ å®šäº†åŸºç¡€ã€‚å®ƒä»¬ä½œä¸ºæŒä¹…æ€§æŒ‡ä»¤ï¼Œå½±å“ç€åç»­çš„æ‰€æœ‰äº¤äº’ã€‚ä¾‹å¦‚ï¼š

```python
system_message = {
    "role": "system",
    "content": "You are a professional customer service agent. Always be polite, clear, and helpful."
}
```

### 1.4 ä¼šè¯

èŠå¤©æ¨¡æ¿é€šè¿‡å¯¹è¯å†å²è®°å½•æ¥ç»´æŒä¸Šä¸‹æ–‡ï¼Œå­˜å‚¨ç”¨æˆ·ä¸åŠ©æ‰‹ä¹‹é—´çš„å…ˆå‰äº¤æµå†…å®¹ã€‚è¿™ä½¿å¾—å¤šè½®å¯¹è¯æ›´åŠ è¿è´¯ã€‚

```python
conversation = [
    {"role": "user", "content": "I need help with my order"},
    {"role": "assistant", "content": "I'd be happy to help. Could you provide your order number?"},
    {"role": "user", "content": "It's ORDER-123"},
]
```

### 1.5 ä½¿ç”¨ Transformer çš„å®ç°

Transformers åº“å†…ç½®äº†å¯¹èŠå¤©æ¨¡æ¿çš„æ”¯æŒã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨æ–¹æ³•ï¼š

```python
from transformers import AutoTokenizer

tokenizer = AutoTokenizer.from_pretrained("HuggingFaceTB/SmolLM2-135M-Instruct")

messages = [
    {"role": "system", "content": "You are a helpful coding assistant."},
    {"role": "user", "content": "Write a Python function to sort a list"},
]

# Apply the chat template
formatted_chat = tokenizer.apply_chat_template(
    messages,
    tokenize=False,
    add_generation_prompt=True
)
"""
<|im_start|>system
You are a helpful coding assistant.<|im_end|>
<|im_start|>user
Write a Python function to sort a list<|im_end|>
<|im_start|>assistant
"""
```

### 1.6 è‡ªå®šä¹‰æ ¼å¼

ä½ å¯ä»¥è‡ªå®šä¹‰ä¸åŒæ¶ˆæ¯ç±»å‹çš„æ ¼å¼ã€‚ä¾‹å¦‚ï¼Œä¸ºä¸åŒè§’è‰²æ·»åŠ ç‰¹æ®Šæ ‡è®°æˆ–è¿›è¡Œæ ¼å¼è®¾ç½®ã€‚

```python
template = """
<|system|>{system_message}
<|user|>{user_message}
<|assistant|>{assistant_message}
""".lstrip()

formatted_text = template.format(
    system_message="ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹",
    user_message="ä½ å¥½ï¼",
    assistant_message="ä½ å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ"
)
```

### 1.7 å¤šè½®æ”¯æŒ

æ¨¡æ¿å¯ä»¥åœ¨ä¿æŒä¸Šä¸‹æ–‡çš„åŒæ—¶å¤„ç†å¤æ‚çš„å¤šè½®å¯¹è¯ã€‚

```python
messages = [
    {"role": "system", "content": "You are a math tutor."},
    {"role": "user", "content": "What is calculus?"},
    {"role": "assistant", "content": "Calculus is a branch of mathematics..."},
    {"role": "user", "content": "Can you give me an example?"},
]
```


### å‚è€ƒèµ„æ–™

- [Hugging Face Chat Templating Guide](https://huggingface.co/docs/transformers/main/en/chat_templating)
- [Transformers Documentation](https://huggingface.co/docs/transformers)
- [Chat Templates Examples Repository](https://github.com/chujiezheng/chat_templates) 









## Exercise Notebooks

| Title                  | Description                                                                          | Exercise                                                                                                                                        | Link                                                 | Colab                                                                                                                                                                                                                                                          |
| ---------------------- | ------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Chat Templates         | Learn how to use chat templates with SmolLM2 and process datasets into chatml format | ğŸ¢ Convert the `HuggingFaceTB/smoltalk` dataset into chatml format <br> ğŸ• Convert the `openai/gsm8k` dataset into chatml format                | [Notebook](./notebooks/chat_templates_example.ipynb) | <a target="_blank" href="https://colab.research.google.com/github/huggingface/smol-course/blob/main/1_instruction_tuning/notebooks/chat_templates_example.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a> |
| Supervised Fine-Tuning | Learn how to fine-tune SmolLM2 using the SFTTrainer                                  | ğŸ¢ Use the `HuggingFaceTB/smoltalk` dataset<br>ğŸ• Try out the `bigcode/the-stack-smol` dataset<br>ğŸ¦ Select a dataset for a real world use case | [Notebook](./notebooks/sft_finetuning_example.ipynb) | <a target="_blank" href="https://colab.research.google.com/github/huggingface/smol-course/blob/main/1_instruction_tuning/notebooks/sft_finetuning_example.ipynb"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"/></a> |
|                        |                                                                                      |                                                                                                                                                 |                                                      |                                                                                                                                                                                                                                                                |

## å¼•ç”¨

- [Transformers documentation on chat templates](https://huggingface.co/docs/transformers/main/en/chat_templating)
- [Script for Supervised Fine-Tuning in TRL](https://github.com/huggingface/trl/blob/main/examples/scripts/sft.py)
- [`SFTTrainer` in TRL](https://huggingface.co/docs/trl/main/en/sft_trainer)
- [Direct Preference Optimization Paper](https://arxiv.org/abs/2305.18290)
- [Supervised Fine-Tuning with TRL](https://huggingface.co/docs/trl/main/en/tutorials/supervised_finetuning)
- [How to fine-tune Google Gemma with ChatML and Hugging Face TRL](https://www.philschmid.de/fine-tune-google-gemma)
- [Fine-tuning LLM to Generate Persian Product Catalogs in JSON Format](https://huggingface.co/learn/cookbook/en/fine_tuning_llm_to_generate_persian_product_catalogs_in_json_format)

